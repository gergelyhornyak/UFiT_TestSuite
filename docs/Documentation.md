# Test Suite Documentation

## Setup

**How to setup the test suite?**

1) Clone this repository
2) Install docker and docker-compose: \
      `(sudo) apt-get install docker docker.io docker-compose`
3) Run the following command: \* \
      `(sudo) docker compose up (--build)` 
4) You should see the logs in the command line, or
5) Check them afterwards using: \
      `(sudo) docker logs testSuiteContainer`
6) You should find the results in the /testOutputs directory
      - GoogleTest results **gtest_report.html** can be opened in a browser
      - LCov code coverage index.html can be opened in a browser

\* `sudo` if not superuser, `--build` if you want to rebuild the base image

> This usually takes around between 10-13m. \
> Running the container without benchmarking is usually 5m.

## Repository Architecture

Repository architecture is as follows:

- root: Dockerfile and docker-compose.yml for running Docker containers, and the README
- /.github: github workflow directory for automated tests,
- /docker: contains the main script and the python venv requirements
- /docs: documentation directory,
- /target: directory for target source code UFiT
- /testOutputs: output of the test suite, including figure(s), data, log(s)
- /testSuite:
    - /testSuite/addons: Python script(s) for mainly plotting the profiling data
    - /testSuite/src: source file(s) of the unit test(s)
    - /testSuite/include: header file(s) of the unit test(s)
    - /testSuite/goldenFiles: golden files for checking outputs or inputs

<div style="page-break-after: always;"></div>

## Fortran Interoperability

### Files

### Modules

### Subroutines

`extern "C"`

`void __ufit_functions_fortran_MOD_intercept_boundary_c000(double* pos_in, double* direction, double* delta_out);`

### Functions

`float __ufit_functions_fortran_MOD_vecdot(float *vec1, float *vec2);`

### Global variables

`extern double __ufit_functions_fortran_MOD_grid1max;`

### Local variables

## Test Extensibility

Unit tests are written in C++ ([docs](https://en.cppreference.com/w/)) and it uses GoogleTest framework ([docs](https://google.github.io/googletest/)). In order to extend the test suite with new unit tests, developers can add a new `TEST()` section inside the appropriate source file in the **src/** directory, in the following way:
 
```c++
TEST(Test_Category, Test_Feature_or_Component)
```

All the unit tests require an assertion or expectation inside the test body.

`EXPECT_` or `ASSERT_`

Either use default main function generated by GTest, or at the bottom of the source file, add your own main function, which should include:

```c++
::testing::InitGoogleTest(&argc, argv);
return RUN_ALL_TESTS();
```

Unit tests can also be disabled for particular feature testing, by inserting the following line inside the test body:

```c++
GTEST_SKIP() << "REASON";
```

Then, after compiling the source files with the GTest libraries, the executable will run the tests sequentially.

## Test Suite Alterations

The main script running the tests can be found in the /docker directory called **list_of_commands.sh**. This script is fairly easily modifiable, since it is a bash script with rich comments.

Phases and subprocesses can be changed or skipped, according to desired run time and results. To do this, comment out the line and optionally change the logs to reflect the ignore of the process.

In case any new 3rd Party Software is introduced to the UFiT, and is mandatory for the testing, then it should also be added to the Test Suite in the following way:

- if it is a Python dependency, then appending it to the **/docker/requirements.txt** file should be enough.
- if it is a free software, such as **git**, then it should be added to the **Dockerfile** file inside the **Install dependencies** section.
- if it is a licenced software, such as 'Intel V-Tune', then it should be added in the **list_of_commands.sh** file, and needs to be downloaded, unpacked, installed, built, and linked (the GTest installation is an example for this case).

> Important note: if the UFiT repository structure changes, any file name changes or any source code is changed which affects the command line functionality, then the Test Suite should be altered accordingly, to reflect the changes.

---

*April 5, 2025*